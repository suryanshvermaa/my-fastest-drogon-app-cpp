# Backend Architecture

This backend follows a conventional Drogon layout with controllers, filters, models, and small utility modules.

## Entry Point: `src/main.cc`
- Registers a pre-routing advice to respond to CORS preflight (OPTIONS).
- Registers a post-handling advice to append `Access-Control-Allow-Origin: *` to all responses.
- Loads `config.json` and runs the app on port 3001 by default.

Key snippet:

```cpp
// CORS preflight and response headers
app().registerPreRoutingAdvice(...);
app().registerPostHandlingAdvice(...);
app().loadConfigFile("config.json").run();
```

## Configuration: `config.json`

```json
{
  "listeners": [{ "address": "0.0.0.0", "port": 3001 }],
  "db_clients": [{
    "rdbms": "postgresql",
    "host": "127.0.0.1",
    "port": 5432,
    "dbname": "userdb",
    "user": "postgres",
    "password": "postgres",
    "is_fast": false
  }]
}
```

Use `config.docker.json` inside containers to connect to the compose service name `postgres`.

## Controllers: `src/controllers/`
- `api_v1_User.*` — signup, login, profile
- `api_v1_todos.*` — CRUD for todos
- `api_v1_health.*` — health check

Controllers are mapped under `/api/v1/<ControllerName>`. Some routes specify absolute paths directly (see Todos controller).

## Filters (Middleware): `src/filters/`
- `auth.*` — Validates `Authorization: Bearer <token>` using JWT-CPP. On success, injects `userId` and `email` into the request parameters; on failure, returns 401 JSON.
- `CorsMiddleware.*` — Optional CORS helper (global headers are already set in `main.cc`).

## Models & ORM: `src/models/`
- Generated by `drogon_ctl` from the DB schema (see `init.sql`).
- `Users` and `Todos` map to DB tables, exposing getters/setters and are used via `drogon::orm::Mapper<T>`.

## Utilities: `src/utils/`
- `token.*` — JWT creation and verification. Claims: `userId`, `email`. Uses `JWT_SECRET` env var.
- `AppError.*` — Lightweight exception carrying an HTTP status code.

## Build: `CMakeLists.txt`
- Enables Drogon ORM, sets C++20, links Drogon, jwt-cpp, and Bcrypt.
- Includes controllers, models, filters, and utils in the single executable `my_drogon_app`.
